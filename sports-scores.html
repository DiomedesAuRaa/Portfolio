<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=240px, initial-scale=1.0">
    <title>Sports Scores</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            font-size: 12px;
            background: #000;
            color: #fff;
            padding: 5px;
            max-width: 240px;
        }
        
        .header {
            position: sticky;
            top: 0;
            background: #000;
            z-index: 100;
            padding-bottom: 2px;
            border-bottom: 1px solid #fff;
        }
        
        .back-btn {
            display: inline-block;
            padding: 2px 6px;
            margin: 2px 0;
            background: #222;
            color: #0ff;
            text-decoration: none;
            font-size: 10px;
            border-radius: 3px;
        }
        
        .back-btn:active {
            background: #333;
        }
        
        h1 {
            font-size: 14px;
            text-align: center;
            padding: 4px 0;
            margin: 0;
        }
        
        .sport-section {
            margin-bottom: 12px;
            border-bottom: 1px solid #444;
            padding-bottom: 8px;
        }
        
        .sport-title {
            font-size: 14px;
            font-weight: bold;
            color: #0ff;
            margin-bottom: 5px;
            padding: 3px 0;
        }
        
        .game {
            background: #111;
            margin: 4px 0;
            padding: 5px;
            border-left: 3px solid #0ff;
            text-decoration: none;
            display: block;
            color: inherit;
        }
        
        .game:active {
            background: #222;
        }
        
        .game-status {
            font-size: 10px;
            color: #888;
            margin-bottom: 2px;
        }
        
        .game-status.live {
            color: #f00;
            font-weight: bold;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        .game-status.live::before {
            content: '';
            display: inline-block;
            width: 6px;
            height: 6px;
            background: #f00;
            border-radius: 50%;
            margin-right: 4px;
            animation: pulse 2s infinite;
        }
        
        .team-row {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
            font-size: 11px;
        }
        
        .team-name {
            flex: 1;
        }
        
        .score {
            font-weight: bold;
            font-size: 13px;
            min-width: 25px;
            text-align: right;
        }
        
        .winner {
            color: #0f0;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #888;
        }
        
        .error {
            text-align: center;
            padding: 10px;
            color: #f00;
            font-size: 11px;
        }
        
        .refresh-btn {
            display: block;
            width: 100%;
            padding: 5px;
            margin: 5px 0;
            background: #0ff;
            color: #000;
            border: none;
            font-weight: bold;
            font-size: 11px;
            cursor: pointer;
        }
        
        .last-update {
            text-align: center;
            font-size: 9px;
            color: #666;
            margin: 2px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="home.html" class="back-btn">‚Üê Back</a>
        <h1>üèÜ SPORTS SCORES</h1>
        <div class="last-update" id="currentDate"></div>
    </div>
    
    <button class="refresh-btn" onclick="loadScores()">‚Üª REFRESH</button>
    <div class="last-update" id="lastUpdate"></div>
    
    <div id="content">
        <div class="loading">Loading scores...</div>
    </div>

    <script>
        // Free sports API endpoint - ESPN's public API
        const API_BASE = 'https://site.api.espn.com/apis/site/v2/sports';
        
        // Detroit/Michigan teams to prioritize
        const PRIORITY_TEAMS = [
            'DET', 'Detroit', 'Lions', 'Pistons', 'Tigers', 'Red Wings',
            'MICH', 'Michigan', 'Wolverines'
        ];
        
        const SPORTS_CONFIG = {
            'NFL': {
                url: `${API_BASE}/football/nfl/scoreboard`,
                color: '#004d40'
            },
            'NCAA FB': {
                url: `${API_BASE}/football/college-football/scoreboard`,
                color: '#8b0000'
            },
            'NBA': {
                url: `${API_BASE}/basketball/nba/scoreboard`,
                color: '#ff6b35'
            },
            'MLB': {
                url: `${API_BASE}/baseball/mlb/scoreboard`,
                color: '#003087'
            },
            'NHL': {
                url: `${API_BASE}/hockey/nhl/scoreboard`,
                color: '#c8102e'
            },
            'SOCCER': {
                url: `${API_BASE}/soccer/usa.1/scoreboard`,
                color: '#00a651'
            }
        };

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            return `${displayHours}:${minutes} ${ampm}`;
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            // Check if same day
            if (date.toDateString() === today.toDateString()) {
                return '';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            } else {
                // Return short date format (e.g., "Nov 15")
                const month = date.toLocaleDateString('en-US', { month: 'short' });
                const day = date.getDate();
                return `${month} ${day}`;
            }
        }
        
        function getGameStatus(competition) {
            const status = competition.status;
            const statusType = status.type.name;
            const gameDate = formatDate(competition.date);
            
            if (statusType === 'STATUS_IN_PROGRESS') {
                const period = status.period ? `${status.type.shortDetail || 'Q' + status.period}` : '';
                const clock = status.displayClock || '';
                return `<span class="live">‚óè LIVE - ${period} ${clock}</span>`.trim();
            } else if (statusType === 'STATUS_FINAL') {
                const finalText = status.type.shortDetail || 'FINAL';
                return gameDate ? `${finalText} - ${gameDate}` : finalText;
            } else if (statusType === 'STATUS_SCHEDULED') {
                const time = formatTime(competition.date);
                return gameDate ? `${gameDate} ${time}` : time;
            }
            return status.type.shortDetail || 'Scheduled';
        }

        function isPriorityTeam(team) {
            const teamName = team.team.abbreviation || team.team.shortDisplayName || team.team.displayName || '';
            return PRIORITY_TEAMS.some(priority => 
                teamName.toUpperCase().includes(priority.toUpperCase())
            );
        }
        
        function renderGame(competition, isPriority = false, showSport = false) {
            const homeTeam = competition.competitors.find(t => t.homeAway === 'home');
            const awayTeam = competition.competitors.find(t => t.homeAway === 'away');
            
            const homeWinner = homeTeam.winner;
            const awayWinner = awayTeam.winner;
            
            const status = getGameStatus(competition);
            
            const priorityBorder = isPriority ? 'border-left: 3px solid #ffd700; background: #1a1a00;' : '';
            const priorityLabel = isPriority ? '<span style="color: #ffd700; font-weight: bold;">‚≠ê </span>' : '';
            const sportLabel = showSport && competition._sportName ? `<span style="color: #0ff; font-size: 10px;">[${competition._sportName}]</span> ` : '';
            
            // Get ESPN game link - look for the gamecast link
            let gameLink = '#';
            if (competition.links) {
                const gamecastLink = competition.links.find(link => link.text === 'Gamecast' || link.text === 'Game Info');
                if (gamecastLink) {
                    gameLink = gamecastLink.href;
                } else if (competition.links[0]) {
                    gameLink = competition.links[0].href;
                }
            }
            
            // If no valid link, make it non-clickable
            const linkTag = gameLink !== '#' ? `<a href="${gameLink}" target="_blank" rel="noopener noreferrer" class="game" style="${priorityBorder}">` : `<div class="game" style="${priorityBorder}">`;
            const closeTag = gameLink !== '#' ? '</a>' : '</div>';
            
            return `
                ${linkTag}
                    <div class="game-status ${competition.status.type.name === 'STATUS_IN_PROGRESS' ? 'live' : ''}">${priorityLabel}${sportLabel}${status}</div>
                    <div class="team-row">
                        <span class="team-name ${awayWinner ? 'winner' : ''}">${awayTeam.team.abbreviation || awayTeam.team.shortDisplayName}</span>
                        <span class="score ${awayWinner ? 'winner' : ''}">${awayTeam.score || '-'}</span>
                    </div>
                    <div class="team-row">
                        <span class="team-name ${homeWinner ? 'winner' : ''}">${homeTeam.team.abbreviation || homeTeam.team.shortDisplayName}</span>
                        <span class="score ${homeWinner ? 'winner' : ''}">${homeTeam.score || '-'}</span>
                    </div>
                ${closeTag}
            `;
        }

        async function fetchSportScores(sportName, config) {
            try {
                const response = await fetch(config.url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                const events = data.events || [];
                
                if (events.length === 0) {
                    return {
                        priorityGames: [],
                        regularGames: [],
                        hasGames: false,
                        sportName: sportName,
                        color: config.color
                    };
                }
                
                // Separate priority and regular games
                const priorityGames = [];
                const regularGames = [];
                
                events.slice(0, 15).forEach(event => {
                    const competition = event.competitions[0];
                    competition._sportName = sportName; // Add sport name to competition
                    const hasPriorityTeam = competition.competitors.some(isPriorityTeam);
                    
                    if (hasPriorityTeam) {
                        priorityGames.push(competition);
                    } else {
                        regularGames.push(competition);
                    }
                });
                
                return {
                    priorityGames: priorityGames,
                    regularGames: regularGames.slice(0, 10),
                    hasGames: events.length > 0,
                    sportName: sportName,
                    color: config.color
                };
            } catch (error) {
                console.error(`Error fetching ${sportName}:`, error);
                return {
                    priorityGames: [],
                    regularGames: [],
                    hasGames: false,
                    sportName: sportName,
                    color: config.color,
                    error: true
                };
            }
        }

        // Cache management
        const CACHE_KEY = 'sports_scores_cache';
        const CACHE_DURATION = 2 * 60 * 1000; // 2 minutes
        
        function getCachedData() {
            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    const data = JSON.parse(cached);
                    if (Date.now() - data.timestamp < CACHE_DURATION) {
                        return data.content;
                    }
                }
            } catch (e) {
                console.error('Cache error:', e);
            }
            return null;
        }
        
        function setCachedData(content) {
            try {
                localStorage.setItem(CACHE_KEY, JSON.stringify({
                    content: content,
                    timestamp: Date.now()
                }));
            } catch (e) {
                console.error('Cache save error:', e);
            }
        }
        
        async function loadScores(forceRefresh = false) {
            const content = document.getElementById('content');
            
            // Show cached data immediately if available
            if (!forceRefresh) {
                const cached = getCachedData();
                if (cached) {
                    content.innerHTML = cached;
                    updateTimestamp();
                    // Refresh in background
                    loadScores(true);
                    return;
                }
            }
            
            content.innerHTML = '<div class="loading">Loading scores...</div>';
            
            try {
                const results = await Promise.all(
                    Object.entries(SPORTS_CONFIG).map(([sport, config]) => 
                        fetchSportScores(sport, config)
                    )
                );
                
                // Collect all priority games across all sports
                const allPriorityGames = [];
                results.forEach(result => {
                    allPriorityGames.push(...result.priorityGames);
                });
                
                // Build favorites section if there are any priority games
                let html = '';
                if (allPriorityGames.length > 0) {
                    html += `
                        <div class="sport-section">
                            <div class="sport-title" style="border-left: 3px solid #ffd700; padding-left: 5px;">‚≠ê FAVORITES</div>
                            ${allPriorityGames.map(comp => renderGame(comp, true, true)).join('')}
                        </div>
                    `;
                }
                
                // Build sections for each sport with regular games
                results.forEach(result => {
                    if (result.error) {
                        html += `
                            <div class="sport-section">
                                <div class="sport-title" style="border-left: 3px solid ${result.color}; padding-left: 5px;">${result.sportName}</div>
                                <div class="error">Unable to load</div>
                            </div>
                        `;
                    } else if (result.regularGames.length > 0) {
                        html += `
                            <div class="sport-section">
                                <div class="sport-title" style="border-left: 3px solid ${result.color}; padding-left: 5px;">${result.sportName}</div>
                                ${result.regularGames.map(comp => renderGame(comp, false, false)).join('')}
                            </div>
                        `;
                    } else if (!result.hasGames && allPriorityGames.length === 0) {
                        html += `
                            <div class="sport-section">
                                <div class="sport-title" style="border-left: 3px solid ${result.color}; padding-left: 5px;">${result.sportName}</div>
                                <div style="padding: 5px; color: #666; font-size: 11px;">No games today</div>
                            </div>
                        `;
                    }
                });
                
                content.innerHTML = html;
                
                // Cache the results
                if (forceRefresh) {
                    setCachedData(html);
                }
                
                updateTimestamp();
                
            } catch (error) {
                content.innerHTML = '<div class="error">Failed to load scores. Check connection.</div>';
            }
        }
        
        function updateTimestamp() {
            const now = new Date();
            const dateOptions = { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' };
            document.getElementById('currentDate').textContent = 
                now.toLocaleDateString('en-US', dateOptions);
            document.getElementById('lastUpdate').textContent = 
                `Updated: ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
        }

        // Keyboard navigation for flip phone D-pad
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === 'SoftRight') {
                const refreshBtn = document.querySelector('.refresh-btn');
                if (refreshBtn) refreshBtn.click();
            }
            if (e.key === 'SoftLeft' || e.key === 'Backspace') {
                window.location.href = 'home.html';
            }
        });
        
        // Load scores on page load
        loadScores();
        
        // Auto-refresh every 2 minutes
        setInterval(() => loadScores(true), 120000);
    </script>
</body>
</html>
